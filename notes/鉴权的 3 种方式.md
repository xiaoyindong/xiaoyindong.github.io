```http```是一种无状态的协议，这就意味着每一次的数据交互，服务是没办法确定请求人身份，所以需要用到用户鉴权，保证服务接收到的每一次请求可以确定是哪一个用户发送的。
## session/cookie

服务器在接受客户端首次访问时在服务器端创建```session```，然后保存```session```(```session```可以保存在内存中，也可以保存在```redis```中)，对```session```生成一个唯一的标识字符串，在响应头中种下这个唯一标识字符串。为了安全可以通过密钥对sid进行签名处理，避免客户端修改sid。

浏览器中收到请求响应的时候会解析响应头，然后将```sid```保存在本地```cookie```中，在下次```http```请求的请求头中会带上这个```cookie```信息。

服务器在接受客户端请求时，解析请求头携带的```cookie```中的```sid```，然后根据这个```sid```去找服务器端保存的```session```断该请求是否合法。


```cookie```存在浏览器里，容量有限4k，一般不安全，最好进行加密处理。

```session```存在服务器，容量无限，是安全的并且```session```不能单独存在，因为他就是基于```cookie```的。

### session使用

安装```koa-session```模块。

```s
npm install koa-session -s;
```

注册```session```。

```js
app.keys = ['some secret', 'another secret'];
const SESS_CONFIG = {
    key: 'yd:sess',
    maxAge: 86400000,
    httpOnly: true,
    signed: true,
}
app.use(session(SESS_CONFIG, app));
app.use(ctx => {
    if (ctx.path === '/facicon.ico') {
        retrun;
    }
    let n = ctx.session.count || 0;
    ctx.session.count = ++n;
    ctx.body = `第${n}次`;
})

```

使用```redis```存储```session```

```s
npm install koa-redis -s;
```

```js
const redisStore = require('koa-redis');
const redis = require('redis');
const client = redis.createClient(6379, '127.0.0.1');
app.use(session({
    key: 'yd:sess',
    store: redisStore({ client })
}, app));
app.use(ctx => {
    client.keys('*', (err, keys) => {
        console.log(keys);
        client.get(key, (err, val) => {
            console.log(val);
        })
    })
})
```

前端登录代码

```js
axios.defaults.withCredentials = true; // 跨域写到cookie
axios.interceptors.response.use(response => {
    app.logs.push(JSON.stringify(response.data));
    return response;
});
var app = new Vue({
    el: '#app',
    data: {
        username: 'test',
        password: 'test',
        logs: []
    },
    methods: {
        login: async function() {
            await axios.post('/users/login', {
                username: this.username,
                password: this.password
            })
        },
        logout: async function() {
            await axios.post('/users/logout');
        },
        getUser: async function() {
            await axios.get('/users/getUser');
        }
    }
})
```

登录注销接口

```js
router.post('/login', async ctx => {
    const body = ctx.request;
    ctx.session.userinfo = body.username;
    ctx.body = {
        ok: 1,
        message: '成功'
    }
})
router.post('/logout', async ctx => {
    delete ctx.session.userinfo;
    ctx.b